#include <stdint.h>
#include "hardware/pio.h"
#include "hardware/dma.h"
#include "pathfinder.h"

#define FBLUT_DMA_CH_A 1
#define FBLUT_DMA_CH_B 2
#define FBLUT_DMA_CH_C 3

#define FBLUT_PIO pio0
#define FBLUT_PIO_SM 0

uint8_t lcd_lut_8b[256] __attribute__((aligned(256), section(".scratch_x.parity"))) = {
    0x0000, 0x2124, 0x4229, 0x634e, 0x8452, 0xa577, 0xce9b, 0xf7be, 0x62ea, 0x83ac, 0x9c6f, 0xad11, 0xbd74, 0xce16, 0xe6d8, 0xff9a, 
    0x5985, 0x71e7, 0x8a88, 0x9b09, 0xab6a, 0xd46d, 0xfd50, 0xfe6f, 0x0146, 0x01ca, 0x026b, 0x0b2f, 0x0371, 0x3474, 0x257a, 0x8ebf, 
    0x6165, 0x91a7, 0xb269, 0xcae9, 0xe3c8, 0xf4c9, 0xfdc9, 0xff49, 0x2969, 0x3a2d, 0x62f0, 0x7bb3, 0x8496, 0x959a, 0xc6bf, 0xc75f, 
    0x0103, 0x0184, 0x1a43, 0x22c3, 0x3341, 0x5444, 0x7d25, 0xa646, 0x1906, 0x2189, 0x222d, 0x3b51, 0x3476, 0x459c, 0x569f, 0x77bf, 
    0x19a5, 0x3207, 0x3a88, 0x32e8, 0x43aa, 0x4c4c, 0x55af, 0x96d4, 0x5842, 0x8104, 0xb1e6, 0xe2ec, 0xfbae, 0xfcd4, 0xfdd8, 0xfedf, 
    0x2987, 0x4a49, 0x5aed, 0x738f, 0x8432, 0xad77, 0xbe3b, 0xef7e, 0x3987, 0x59e8, 0x8a8b, 0xab4c, 0xc40d, 0xd4ee, 0xee30, 0xffd5, 
    0x3105, 0x49a7, 0x5a29, 0x72ca, 0x7b6a, 0x9c4d, 0xbd31, 0xddf3, 0x3085, 0x4947, 0x61ab, 0x92ae, 0xb372, 0xbbd5, 0xdcd7, 0xf63b, 
    0x0169, 0x020a, 0x028c, 0x034d, 0x040f, 0x0510, 0x05f4, 0x06fb, 0x4184, 0x6247, 0x7b08, 0x9bca, 0xb48c, 0xcd4d, 0xe650, 0xff54, 
    0x6045, 0x6926, 0x9229, 0xa30b, 0xbbec, 0xccae, 0xedaf, 0xee92, 0x31ab, 0x4a90, 0x6333, 0x7bb7, 0x8c7b, 0x9cdd, 0xb57f, 0xde9f, 
    0x40c5, 0x7167, 0x99ea, 0xd24d, 0xf2f0, 0xfbf5, 0xfd38, 0xfe7f, 0x4923, 0x61a6, 0x7a69, 0x92cb, 0xab6d, 0xbbef, 0xd46f, 0xe4cf, 
    0x2140, 0x3281, 0x4ae0, 0x6381, 0x7c04, 0x94c5, 0xb546, 0xce46, 0x6140, 0x71e1, 0x8282, 0x9b24, 0xbc46, 0xcd47, 0xe689, 0xffaa, 
    0x2927, 0x39ca, 0x528d, 0x734d, 0x93cf, 0xb4b0, 0xcd71, 0xfef6, 0x2168, 0x31e9, 0x3a67, 0x4ae6, 0x5b85, 0x6c25, 0x7ce4, 0x7de7, 
    0x3924, 0x51c7, 0x7a69, 0x92ea, 0xab6b, 0xbbec, 0xd48e, 0xf510, 0x2a69, 0x4b2b, 0x5bcd, 0x74af, 0x8571, 0x8e12, 0xae97, 0xdfdd, 
    0x00e8, 0x018c, 0x0a4f, 0x12f4, 0x13b7, 0x44bc, 0x559d, 0x6e5f, 0x524d, 0x72ee, 0x93b1, 0xb472, 0xd513, 0xedf3, 0xfeb3, 0xffb0, 
    0x20e4, 0x398a, 0x5a4f, 0x7b37, 0x943d, 0xacbd, 0xbd5e, 0xcdff, 0x292a, 0x29ab, 0x29ee, 0x3a90, 0x5335, 0x53b8, 0x6c18, 0x8498, 
    0x4905, 0x5a09, 0x72ab, 0x930d, 0xabd0, 0xb452, 0xd575, 0xff19, 0x70e0, 0x99a5, 0xbac8, 0xe425, 0xfd81, 0xfe61, 0xff65, 0xf797
};

static struct {
    // PIO configurations
    uint32_t pio_offset_fblut;
    pio_sm_config pio_cfg_fblut;
    
    // DMA configurations for write
    dma_channel_config dmacfg_write_chA; // Copy bytes from RAM Framebuffer to PIO
    dma_channel_config dmacfg_write_chB; // Copy address from PIO to lookup table DMA (C) READ_ADDR register
    dma_channel_config dmacfg_write_chC; // Copy from lookup table into LCD write buffer (direct to 16*8 SPI fifo?)
} cfg_fb_lut;

void framebuffer_pio_init() {
    // Claim PIO with SDK
    pio_sm_claim(FBLUT_PIO, FBLUT_PIO_SM);

}

void framebuffer_dma_init() {
    // Claim DMA with SDK
    dma_channel_claim(FBLUT_DMA_CH_A);
    dma_channel_claim(FBLUT_DMA_CH_B);
    dma_channel_claim(FBLUT_DMA_CH_C);

    // Create DMA channel configurations so they can be applied quickly later
    
    // Channel A: Copy bytes from RAM Framebuffer to PIO
    dma_channel_config cfg = dma_channel_get_default_config(FBLUT_DMA_CH_A);
    channel_config_set_transfer_data_size(&cfg, DMA_SIZE_8);
    channel_config_set_read_increment(&cfg, true);
    channel_config_set_write_increment(&cfg, false);
    channel_config_set_dreq(&cfg, pio_get_dreq(FBLUT_PIO, FBLUT_PIO_SM, true));
    cfg_fb_lut.dmacfg_write_chA = cfg;

    // Channel B: Copy address from PIO to lookup table DMA (C) READ_ADDR register
    cfg = dma_channel_get_default_config(FBLUT_DMA_CH_B);
    channel_config_set_transfer_data_size(&cfg, DMA_SIZE_32);
    channel_config_set_read_increment(&cfg, false);
    channel_config_set_write_increment(&cfg, false);
    channel_config_set_dreq(&cfg, pio_get_dreq(FBLUT_PIO, FBLUT_PIO_SM, false));
    cfg_fb_lut.dmacfg_write_chB = cfg;

    // Channel C: Copy from lookup table into SPI FIFO
    cfg = dma_channel_get_default_config(FBLUT_DMA_CH_C);
    channel_config_set_transfer_data_size(&cfg, DMA_SIZE_16);
    channel_config_set_read_increment(&cfg, false);
    channel_config_set_write_increment(&cfg, false);
    channel_config_set_dreq(&cfg, spi_get_dreq(LCD_SPI_PERIPHERAL, true));
    channel_config_set_chain_to(&cfg, FBLUT_DMA_CH_B);
    cfg_fb_lut.dmacfg_write_chC = cfg;
}